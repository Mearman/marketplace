#!/usr/bin/env npx tsx
/**
 * Search for CVEs by ID or product name
 * Usage: npx tsx lookup.ts [cve-id | --product <name>] [options]
 *
 * Options:
 *   --no-cache   Bypass cache and fetch fresh data
 *   --limit <n>  Limit results (for product search, default 10)
 */

import {
	parseArgs,
	searchCVEById,
	searchCVEByProduct,
	formatCVEOutput,
} from "./utils";

const main = async () => {
	const { flags, options, positional } = parseArgs(process.argv.slice(2));
	const cveId = positional[0];
	const product = options.get("product");
	const bypassCache = flags.has("no-cache");
	const limit = parseInt(options.get("limit") || "10", 10);

	if (!cveId && !product) {
		console.log(`CVE Lookup Tool

Usage:
  npx tsx lookup.ts <cve-id> [options]           # Search by CVE ID
  npx tsx lookup.ts --product <name> [options]   # Search by product name

Options:
  --no-cache     Bypass cache and fetch fresh data
  --limit <n>    Limit results for product search (default: 10)

Examples:
  npx tsx lookup.ts CVE-2024-1086
  npx tsx lookup.ts --product OpenSSL
  npx tsx lookup.ts --product "Apache Struts" --no-cache --limit 5`);
		process.exit(1);
	}

	try {
		if (product) {
			// Search by product
			console.log(`Searching for CVEs affecting "${product}"...\n`);
			const results = await searchCVEByProduct(product, bypassCache, limit);

			if (results.length === 0) {
				console.log(`❌ No CVEs found for "${product}"`);
				process.exit(0);
			}

			console.log(`Found ${results.length} CVE(s):\n`);
			results.forEach((cve) => {
				console.log(formatCVEOutput(cve));
			});
		} else {
			// Search by CVE ID
			console.log(`Searching for ${cveId}...\n`);
			const cve = await searchCVEById(cveId, bypassCache);

			if (!cve) {
				console.log(`❌ CVE not found: ${cveId}`);
				console.log(
					"\nNote: Some CVEs may not be available in the public database."
				);
				process.exit(1);
			}

			console.log(formatCVEOutput(cve));
		}
	} catch (error) {
		console.error("Error:", error instanceof Error ? error.message : error);
		process.exit(1);
	}
};

void main();
